<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ˜Ÿå®ˆæˆ¦ç·šæˆ¦æ³ - é˜²è¡›</title>
<style>
body {
  margin:0;
  font-family:"Consolas","Roboto Mono",monospace;
  background:#000;
  color:#e0e0e0;
  display:flex;
  flex-direction:column;
}

/* å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’ç¢ºä¿ */
#header-container { width:100%; }

#announcement {
  width:100%;
  text-align:center;
  font-size:1em;
  white-space:nowrap;
  overflow:hidden;
  height:2em;
  margin-top:5px;
  color:#7fe8ff;
}
.scroll-text { display:inline-block; }

#main-container { display:flex; flex:1; }
#map {
  position:relative;
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:600px;
}
#status-panel {
  width:280px;
  background:#111;
  border-left:1px solid #555;
  padding:10px;
  overflow-y:auto;
  max-height:100%;
}
.status-entry { border-bottom:1px solid #333; padding:6px 0; font-size:0.85em; }

.base {
  position:absolute;
  width:55px; height:55px;
  border-radius:50%;
  background:rgba(90,200,255,0.2);
  border:2px solid #8ae1ff;
  display:flex; justify-content:center; align-items:center;
  font-size:0.8em;
  color:#fff;
  cursor:pointer;
  transition:all 0.5s ease;
}
.hp-bar {
  width:40px; height:4px;
  background:#222;
  border:1px solid #444;
  position:absolute;
  bottom:-8px;
  left:7px;
  border-radius:2px;
}
.hp-fill { height:100%; border-radius:2px; background:#00ff9d; }

.modal-bg {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:100;
}
.modal-content {
  background:#222;
  padding:20px;
  border:2px solid #8ae1ff;
  border-radius:8px;
  text-align:center;
  max-height:80%;
  overflow-y:auto;
}
.modal-content button {
  margin:5px;
  padding:8px 12px;
  background:#111;
  border:1px solid #8ae1ff;
  color:#8ae1ff;
  cursor:pointer;
}
.modal-content button:hover {
  background:#8ae1ff; color:#000;
}
</style>
</head>
<body>

<!-- å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div id="header-container"></div>
<script src="../common/header-loader.js"></script>

<!-- ãŠçŸ¥ã‚‰ã› -->
<div id="announcement"><span id="announcementText" class="scroll-text"></span></div>

<!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
<div id="main-container">
  <div id="map"></div>
  <div id="status-panel"></div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="modalBg">
  <div class="modal-content" id="modalContent">
    <h3 id="modalTitle"></h3>
    <div id="modalBody"></div>
    <div>
      <button id="combatBtn">âš” æˆ¦é—˜</button>
      <button id="exploreBtn">ğŸ§­ æ¢ç´¢</button>
      <button id="rescueBtn">ğŸ©¹ æ•‘åŠ©</button>
    </div>
    <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
// ---------------------------
// åŸºæœ¬è¦ç´ å–å¾—
const map = document.getElementById("map");
const statusPanel = document.getElementById("status-panel");
const modalBg = document.getElementById("modalBg");
const modalTitle = document.getElementById("modalTitle");
const modalBody = document.getElementById("modalBody");
const combatBtn = document.getElementById("combatBtn");
const exploreBtn = document.getElementById("exploreBtn");
const rescueBtn = document.getElementById("rescueBtn");

let currentChar = JSON.parse(localStorage.getItem("currentChar")) || { name:"æœªè¨­å®š", recentActions:[] };

// ç¨®é¡åˆ¥ãƒ­ã‚°
const combatLog = JSON.parse(localStorage.getItem("combatLog")) || [];
const exploreLog = JSON.parse(localStorage.getItem("exploreLog")) || [];
const rescueLog = JSON.parse(localStorage.getItem("rescueLog")) || [];

const bases = [];
const numBases = 20;
const radius = 250;
let selectedBase = null;

// ---------------------------
// æ‹ ç‚¹ç”Ÿæˆ
for(let i=0;i<numBases;i++){
  const base = document.createElement("div");
  base.classList.add("base");
  base.dataset.id = i===0 ? "æœ¬éƒ¨" : `æ‹ ç‚¹${i}`;
  base.dataset.hp = 100;
  base.dataset.resource = (Math.random()*4000+1000).toFixed(0);
  base.dataset.enemies = Math.floor(Math.random()*300);
  base.textContent = base.dataset.id;

  const hpBar = document.createElement("div");
  hpBar.classList.add("hp-bar");
  const hpFill = document.createElement("div");
  hpFill.classList.add("hp-fill");
  hpBar.appendChild(hpFill);
  base.appendChild(hpBar);

  map.appendChild(base);
  bases.push(base);

  base.addEventListener("click", ()=>{
    selectedBase = base;
    modalBg.style.display="flex";
    modalTitle.textContent = base.dataset.id;
    modalBody.innerHTML = `<p>é¸æŠã—ãŸæ‹ ç‚¹: ${base.dataset.id}</p>`;
  });
}

// ---------------------------
// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
function closeModal(){ modalBg.style.display="none"; }
modalBg.addEventListener("click",(e)=>{ if(e.target===modalBg) closeModal(); });

// ---------------------------
// æ‹ ç‚¹é…ç½®
function positionBases(){
  const centerX = map.offsetWidth/2;
  const centerY = map.offsetHeight/2;
  bases.forEach((base,i)=>{
    if(i===0){
      base.style.left = `${centerX-27.5}px`;
      base.style.top = `${centerY-27.5}px`;
      return;
    }
    const angle = ((i-1)/(numBases-1))*2*Math.PI;
    const distortX = Math.sin(angle*3)*10;
    const distortY = Math.cos(angle*5)*10;
    base.style.left = `${centerX + radius*Math.cos(angle)+distortX-27.5}px`;
    base.style.top = `${centerY + radius*Math.sin(angle)+distortY-27.5}px`;
  });
}
positionBases();
window.addEventListener("resize", positionBases);

// ---------------------------
// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
function updateBases(){
  bases.forEach(base=>{
    if(base.dataset.id==="æœ¬éƒ¨") return;
    let hp = Math.max(0, base.dataset.hp - Math.random()*5);
    base.dataset.hp = hp.toFixed(0);
    base.dataset.enemies = Math.max(0, base.dataset.enemies - Math.random()*5).toFixed(0);
    base.dataset.resource = (parseInt(base.dataset.resource)+Math.random()*30-15).toFixed(0);
    const hpFill = base.querySelector(".hp-fill");
    hpFill.style.width = `${hp}%`;
    hpFill.style.background = hp>60?"#00ff9d": hp>30?"#ffeb3b":"#ff4b4b";
  });
  updateStatusPanel();
}

function updateStatusPanel(){
  statusPanel.innerHTML="<h3>æ‹ ç‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>";
  bases.forEach(base=>{
    const entry = document.createElement("div");
    entry.classList.add("status-entry");
    entry.innerHTML = `<strong>${base.dataset.id}</strong><br>
      ğŸ’šHP: ${base.dataset.hp}%ã€€ğŸª¨è³‡æº: ${base.dataset.resource}ã€€ğŸ‘¾æ•µæ•°: ${base.dataset.enemies}`;
    statusPanel.appendChild(entry);
  });
}

// ---------------------------
// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ­ã‚°è¿½åŠ 
function addAction(action, type){
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = `[${timestamp}] ${action}`;
  currentChar.recentActions.unshift(logEntry);
  if(currentChar.recentActions.length>50) currentChar.recentActions.pop();
  localStorage.setItem("currentChar", JSON.stringify(currentChar));

  if(type==="combat"){
    combatLog.unshift(logEntry); if(combatLog.length>50) combatLog.pop();
    localStorage.setItem("combatLog", JSON.stringify(combatLog));
  } else if(type==="explore"){
    exploreLog.unshift(logEntry); if(exploreLog.length>50) exploreLog.pop();
    localStorage.setItem("exploreLog", JSON.stringify(exploreLog));
  } else if(type==="rescue"){
    rescueLog.unshift(logEntry); if(rescueLog.length>50) rescueLog.pop();
    localStorage.setItem("rescueLog", JSON.stringify(rescueLog));
  }
}

// ---------------------------
// æ¢ç´¢å‡¦ç†
function openResultModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  modalBg.style.display = "flex";
}

function performExplore(type){
  if(!selectedBase) return;

  let actionText = `${selectedBase.dataset.id}ã§${type}è¡Œå‹•`;
  addAction(actionText, "explore");

  // ãƒ©ãƒ³ãƒ€ãƒ çµæœ
  const resources = Math.floor(Math.random()*100 + 50);
  const enemies = Math.floor(Math.random()*10);

  // æ‹ ç‚¹ãƒ‡ãƒ¼ã‚¿æ›´æ–°
  selectedBase.dataset.resource = (parseInt(selectedBase.dataset.resource) + resources).toFixed(0);
  selectedBase.dataset.enemies = (parseInt(selectedBase.dataset.enemies) + enemies).toFixed(0);

  // çµæœè¡¨ç¤º
  const html = `
    <p>${selectedBase.dataset.id}ã‚’${type}ã—ã¾ã—ãŸï¼</p>
    <p>è³‡æºã‚’${resources}ç²å¾—</p>
    <p>æ•µã‚’${enemies}ç¢ºèª</p>
  `;
  openResultModal("æ¢ç´¢çµæœ", html);

  updateBases();
}

// ---------------------------
// ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒœã‚¿ãƒ³ã®ç´ä»˜ã‘
function handleAction(type){
  if(!selectedBase) return;

  if(type==="explore"){
    // æ¢ç´¢ç¨®é¡é¸æŠUI
    const optionsHtml = `
      <p>${selectedBase.dataset.id}ã§ã©ã®æ¢ç´¢ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ</p>
      <button id="searchBtn">èª¿æŸ»</button>
      <button id="gatherBtn">æ¡å–</button>
      <button id="huntBtn">ç‹©çŒŸ</button>
    `;
    modalBody.innerHTML = optionsHtml;

    document.getElementById("searchBtn").onclick = ()=>performExplore("èª¿æŸ»");
    document.getElementById("gatherBtn").onclick = ()=>performExplore("æ¡å–");
    document.getElementById("huntBtn").onclick = ()=>performExplore("ç‹©çŒŸ");
  } else {
    let actionText = "";
    switch(type){
      case "combat": actionText = `${selectedBase.dataset.id}ã§æˆ¦é—˜è¡Œå‹•`; break;
      case "rescue": actionText = `${selectedBase.dataset.id}ã§æ•‘åŠ©è¡Œå‹•`; break;
    }
    addAction(actionText, type);
    closeModal();
    window.location.href = `/hosimori/log/results.html#${type}`;
  }
}

combatBtn.onclick = ()=>handleAction("combat");
exploreBtn.onclick = ()=>handleAction("explore");
rescueBtn.onclick = ()=>handleAction("rescue");

// ---------------------------
// åˆæœŸæ›´æ–°
updateStatusPanel();
updateBases();
setInterval(updateBases,5000);

</script>
</body>
</html>
